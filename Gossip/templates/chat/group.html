
<!DOCTYPE html>
<html>
 <head>
   <meta charset="utf-8" />
   <title>Chat group</title>
 </head>
 <body>
   <div id="chat-container">
     <div id="username-container">
       <input
         id="username-input"
         type="text"
         placeholder="Enter your username"
       />
       <button id="set-username-button">Set Username</button>
     </div>
     <div
       id="chat-log"
       style="
         height: 400px;
         overflow-y: auto;
         border: 1px solid #ccc;
         margin-bottom: 10px;
         padding: 10px;
       "
     ></div>
     <div id="chat-input-container">
       <input id="chat-message-input" type="text" size="100" />
       <button id="chat-message-submit">Send</button>
     </div>
   </div>
   <script>
     let chatSocket = null;
     let streamToken = null;
     let username = null;

     // Initialize WebSocket connection
     function connectWebSocket() {
       const groupName = "{{ group_name }}";
       const wsProtocol =
         window.location.protocol === "https:" ? "wss:" : "ws:";
       chatSocket = new WebSocket(
         `${wsProtocol}//${window.location.host}/ws/chat/${groupName}/`
       );

       chatSocket.onopen = function (e) {
         console.log("WebSocket connection established");
       };

       chatSocket.onmessage = function (e) {
         const data = JSON.parse(e.data);

         if (data.type === "connection_established") {
           // Store the Stream token
           streamToken = data.token;
           console.log("Received Stream token:", streamToken);

           // Join or create channel
           sendWebSocketMessage({
             type: "create_channel",
             channel_id: "lobby",
           });
         } else if (data.type === "message_sent") {
           // Handle sent messages
           appendMessage(data.message);
         } else if (data.type === "message_received") {
           // Handle received messages
           appendMessage(data.message);
         } else if (data.type === "username_set") {
           username = data.username;
           streamToken = data.token; // Update the stream token
           console.log("Username set:", username);
         } else if (data.type === "error") {
           console.error("Error:", data.message);
         }
       };

       chatSocket.onclose = function (e) {
         console.error("Chat socket closed unexpectedly");
         // Optionally implement reconnection logic here
         setTimeout(connectWebSocket, 3000);
       };
     }
     function appendMessage(message) {
       const chatLog = document.getElementById("chat-log");
       const messageDiv = document.createElement("div");
       messageDiv.textContent = `${message.user.name}: ${message.text}`;
       chatLog.appendChild(messageDiv);
       chatLog.scrollTop = chatLog.scrollHeight;
     }
     // Set up event listeners
     document.addEventListener("DOMContentLoaded", function () {
       const usernameInput = document.getElementById("username-input");
       const setUsernameButton = document.getElementById(
         "set-username-button"
       );
       const messageInput = document.getElementById("chat-message-input");
       const submitButton = document.getElementById("chat-message-submit");

       setUsernameButton.addEventListener("click", function () {
         const newUsername = usernameInput.value.trim();
         if (newUsername) {
           sendWebSocketMessage({
             type: "set_username",
             username: newUsername,
           });
         }
       });

       messageInput.addEventListener("keypress", function (e) {
         if (e.key === "Enter") {
           submitButton.click();
         }
       });

       submitButton.addEventListener("click", function () {
         const message = messageInput.value.trim();
         if (message) {
           if (!username) {
             alert("Please set your username first!");
             return;

    }
           sendWebSocketMessage({
             type: "send_message",
             message: message,
             username: username, // Add username to the message
           });
           messageInput.value = "";
         }
       });
              // Initialize WebSocket connection
       connectWebSocket();
     });
   </script>
 </body>
</html>
     